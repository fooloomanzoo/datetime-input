<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../number-input/integer-input.html">

<link rel="import" href="datetime-input-mixin.html">

<script>
  /**
   *
   * Mixin to extend an element to a time input
   *
   * @demo demo/index.html
   * @demo demo/form.html Form
   **/
  const TimeInputPattern = (superClass) => { // eslint-disable-line no-unused-vars

    return class extends superClass { // eslint-disable-line no-undef

      static get inputTemplate() {
        return `
          <div style$="order:[[_computePartOrder(dateOrder.timeFirst)]];" hidden$="[[_ifClamped(clamp, 'hour')]]">
            <template is="dom-if" if="[[!hour12Format]]">
              <integer-input value="{{hour}}" id="hour" hidden$="[[partsHidden.hour]]" pad-length="2" no-clamp placeholder="00" step="[[partsStep.hour]]" disabled="[[partsDisabled.hour]]"></integer-input>
            </template>
            <template is="dom-if" if="[[hour12Format]]">
              <integer-input value="{{hour12}}" hidden$="[[partsHidden.hour]]" pad-length="2" no-clamp placeholder="00" step="[[partsStep.hour]]" disabled="[[partsDisabled.hour]]"></integer-input>
            </template>
            <span hidden$="[[partsHidden.hour]]">[[timeSeparator]]</span>
            <integer-input id="minute" value="{{minute}}" hidden$="[[partsHidden.minute]]" pad-length="2" no-clamp step="[[partsStep.minute]]" disabled="[[partsDisabled.minute]]" placeholder="00"></integer-input>
            <span hidden$="[[partsHidden.minute]]">[[timeSeparator]]</span>
            <integer-input hidden$="[[partsHidden.second]]" pad-length="2" no-clamp step="[[partsStep.second]]" disabled="[[partsDisabled.second]]" value="{{second}}" placeholder="00"></integer-input>
            <template is="dom-if" if="[[partsHidden.second]]">
              <span hidden$="[[partsHidden.millisecond]]">0</span>
            </template>
            <span hidden$="[[partsHidden.millisecond]]">[[decimalSeparator]]</span>
            <integer-input value="{{millisecond}}" hidden$="[[partsHidden.millisecond]]" pad-length="3" no-clamp step-mod="1000" step="[[partsStep.millisecond]]" disabled="[[partsDisabled.millisecond]]" placeholder="000"></integer-input>
            <template is="dom-if" if="[[hour12Format]]">
              <button class="hour12" hidden$="[[!_valueIsSet]]" on-click="_switchAm">
                <span hidden$="[[!isAm]]">[[amString]]</span>
                <span hidden$="[[isAm]]">[[pmString]]</span>
              </button>
            </template>
            <template is="dom-if" if="[[withTimezone]]">
              <integer-input value="{{_timeZoneHours}}" pad-length="2" always-sign step="1" placeholder="+00" min="-23" max="23"></integer-input>
              <span>[[timeSeparator]]</span>
              <integer-input value="{{_timeZoneMinutes}}" pad-length="2" min="0" max="45" step="15" placeholder="00"></integer-input>
            </template>
          </div>
          ${super.inputTemplate || ''}
        `;
      }

      static get customStyleContent() {
        return `
          ${super.customStyleContent || ''}
          #input .hour12 {
            -moz-appearance: none;
            -webkit-appearance: none;
            appearance: none;
            color: inherit;
            background: transparent;
            align-self: stretch;
            cursor: pointer;
            font-size: 0.8em;
            margin: 0 0.2em;
            padding: 0.1em;
            border-radius: var(--input-border-radius, 0.2em);
            border: var(--input-border, thin dotted transparent);
            transition: var(--input-transition, background 250ms cubic-bezier(0.6, 1, 0.2, 1));
            @apply --input-style;
            border-color: transparent;
          }
          #input integer-input[always-sign] {
            --input-allign: end;
          }
          #input .hour12:hover,
          #input .hour12:focus {
            color: var(--input-focus-color, inherit);
            background: var(--input-focus-background, rgba(0,0,0,0.16));
            border: var(--input-focus-border, thin dotted currentColor);
            @apply --input-focus;
            outline: none;
          }
        `
      }

      static get properties() {
        return {
          /**
           * Clamp timetime to a property
           * possible values: 'month', 'day', 'hour', 'minute', 'second', 'millisecond' or ''
           */
          clamp: {
            type: String,
            value: ''
          },

          withTimezone: {
            type: Boolean,
            value: false
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        let d;
        if (this.default) {
          d = new Date(this.default);
        }
        if (isNaN(d)) {
          d = new Date();
        }
        setTimeout(() => {
          this.root.querySelector('#hour').startAt = d.getHours();
          this.$.minute.startAt = d.getMinutes();
        })
      }

      _switchAm() {
        this.isAm = !this.isAm;
      }
    }
  }
</script>

<dom-module id="time-input">
  <script>
    /**
     *  `<time-input>` is an input for time for **[Polymer](https://github.com/Polymer/polymer)**
     *
     *  ```html
     *    <time-input value="{{value}}"></time-input>
     *  ```
     *
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--input-color`                   | color of the input                           | inherit
     * `--input-background`              | background of the input                      | transparent
     * `--input-border`                  | border of the input                          | thin dotted transparent
     * `--input-padding`                 | padding of the input                         | 0.16em
     * `--input-border-radius`           | border-radius of the input                   | 0.16em
     * `--input-transition`              | transition of the input                      | background 250ms cubic-bezier(0.6, 1, 0.2, 1)
     * `--input-cursor`                  | cursor of the input input                    | initial
     * `--input-focus-color`             | color of the focussed and hovered input      | inherit
     * `--input-focus-background`        | background of the focussed and hovered input | rgba(0,0,0,0.16)
     * `--input-focus-border`            | border of the focussed and hovered input     | thin dotted currentColor
     * `--input-invalid-color`           | color of the invalid input                   | inherit
     * `--input-invalid-background`      | background of the invalid input              | rgba(255,0,0,0.16)
     * `--input-invalid-border`          | border of the invalid input                  | thin dotted rgba(255,0,0,0.5)
     * `--input-disabled-color`          | color of the disabled input                  | inherit
     * `--input-disabled-background`     | background of the disabled input             | transparent
     * `--input-disabled-font-style`     | font-style of the disabled input             | italic
     * `--input-disabled-opacity`        | opacity of the disabled input                | 1
     * `--input-placeholder-color`       | color of the placeholder                     | inherit
     * `--input-placeholder-opacity`     | opacity of the placeholder                   | 0.75
     * `--input-selection-color`         | color of the selected text                   | inherit
     * `--input-selection-background`    | background of the selected text              | rgba(255,255,255,0.5
     * `--input-style`                   | style of the input                           | {}
     * `--input-focus`                   | style of the focussed and hovered input      | {}
     * `--input-invalid`                 | style of the invalid input                   | {}
     * `--input-placeholder`             | style of the placeholder                     | {}
     *
     *  @polymer
     *  @customElement
     *
     *  @appliesMixin TimeInputPattern
     *  @appliesMixin DatetimeInputMixin
     *
     * @demo demo/index.html
     * @demo demo/form.html in a form
     **/
    class TimeInput extends TimeInputPattern(DatetimeInputMixin(Polymer.Element)) { // eslint-disable-line no-undef

      static get is() {
        return 'time-input';
      }

      _dateTimeChanged(date, time) {
        if (this.__updatingTimezoneOffset) {
          return;
        }
        if (time === undefined) {
          if (this.default !== undefined) {
            this._setDate(new Date(this.default));
          } else {
            this._resetDate();
          }
          return;
        }
        this.datetime = (date || '1970-01-01') + 'T' + (time || (this.timezone ? this.timezone.slice(1) : '00:00')) + (this.timezone || 'Z');
      }

    }
    window.customElements.define(TimeInput.is, TimeInput);
  </script>
</dom-module>
