<link rel="import" href="../input-picker-pattern/input-shared-style.html">
<link rel="import" href="../input-picker-pattern/input-picker-shared-style.html">
<link rel="import" href="../input-picker-pattern/form-element-mixin.html">
<link rel="import" href="../property-mixins/datetime-mixin.html">
<link rel="import" href="../property-mixins/intl-datetime-format-mixin.html">
<link rel="import" href="../number-input/integer-input.html">

<script>
  /**
   * Mixin to extend an element for combining form-element-mixin and datetime-mixin
   *
   * @appliesMixin FormElementMixin
   * @appliesMixin DatetimeMixin
   * @appliesMixin IntlDatetimeFormatMixin
   */
   const DatetimeFormMixin = superClass => { // eslint-disable-line no-unused-vars

     return class extends FormElementMixin(DatetimeMixin(IntlDatetimeFormatMixin(superClass))) { // eslint-disable-line no-undef

       static get properties() {
         return {
           /**
            * defines the property that should be used for the value
            */
           propertyForValue: {
             type: String,
             value: 'valueAsNumber'
           }
         }
       }

       _defaultChanged(def) {
         // overwrite form-element-mixin's behaviour in favour of datetime-mixins handling
         if (this._isSet(def) === false) {
           this.default = undefined;
         }
       }

       _isSet(value) {
         return !(typeof value === 'boolean' || value === undefined || value === null || value === '');
       }

       _valueChanged(value) {
         // test if value is set and if needed set value to default
         if (this._isSet(value) === false) {
           this.resetDate();
         }
       }
     }
   }
   window.DatetimeFormMixin = DatetimeFormMixin;
  /**
   * Mixin to extend an element for an datetime input element
   *
   * @appliesMixin DatetimeFormMixin
   *
   * @mixinFunction
   * @polymer
   *
   * @param {Object} superClass class to extend
   * @return {Object} extended class
   */
  const DatetimeInputMixin = superClass => { // eslint-disable-line no-unused-vars

    return class extends DatetimeFormMixin(superClass) { // eslint-disable-line no-undef

      static get template() {
        return `
          <style include="${this.styleToInclude}">
            ${this.styleTemplate}
          </style>
          <div id="input">
            ${this.inputTemplate}
          </div>
        `
      }

      static get styleToInclude() {
        return `${super.styleToInclude || ''} input-shared-style`;
      }

      static get styleTemplate() {
        return `
          ${super.styleTemplate || ''}
          :host {
            display: inline-flex;
            outline: none;
          }
          #input,
          #input > div {
            display: inline-flex;
            align-items: baseline;
          }
          #input > div {
            padding: var(--input-field-padding, 0 1px);
            border: var(--input-border-width, thin) solid transparent;
          }
          #input .reset {
            order: 2;
          }
          #input integer-input[always-sign] {
            --input-align: end;
          }
        `;
      }

      /**
       * template for the focusable
       * @type {string}
       */
      static get inputTemplate() {
        return `
          <template is="dom-if" if="[[withTimezone]]">
            <div style$="order:[[_computePartOrder(dateOrder.timeFirst)]];">
              <integer-input value="{{_timeZoneHours}}" pad-length="2" always-sign step="1" placeholder="Â±00" min="-23" max="23" use-negative-zero></integer-input>
              <span>[[timeSeparator]]</span>
              <integer-input value="{{_timeZoneMinutes}}" pad-length="2" min="0" max="45" step="15" placeholder="00"></integer-input>
            </div>
          </template>
          <button class="icon reset" invisible$="[[_resetButtonIsInvisible]]" hidden$="[[_computeOr(disabled,hideResetButton)]]" on-click="resetDate">
            <svg viewBox="0 0 24 24"><g><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></g></svg>
          </button>
          ${super.inputTemplate || ''}
        `
      }

      static get properties() {
        return {
          /**
          * If set the step defines the step a date should be incremented (in seconds). The input for the most inferior standing that would create an integer step is used to increment the value.
          * For example, if the **step** is:
          *  + **0.05**: the millisecond-input will increment the value by 50 (50 milliseconds), the other inputs behaive as expected
          *  + **1.05**: the millisecond-input will increment the value by 1050 (1 second and 50 millisecond), the other inputs behaive as expected
          *  + **2**: the millisecond-input will be disabled, the second-input will increment the value by 2000 (2 seconds), the other inputs behaive as expected
          *  + **180**: the millisecond-input and the second-input will be disabled, the minute-input will increment the value by 180000 (3 minutes), the other inputs behaive as expected
          * If `step="0"` all inputs will be disabled, else if the step is below _0.001_ the step will be set to **0.001**. The most supirior input that will become the given step is the day-input.
           */
          step: {
            type: Number,
            notify: true
          },

          /**
           * date-parts that are disabled
           */
          _partsDisabled: {
            type: Object,
            notify: true,
            value: function() {
              return {}
            }
          },

          /**
           * the computed steps for the date-parts
           */
          _partsStep: {
            type: Object,
            notify: true,
            readOnly: true,
            value: function() {
              return {
                day: 1,
                hour: 1,
                minute: 1,
                second: 1,
                millisecond: 1
              }
            }
          },

          /**
           * if true, the reset button is hidden
           */
          hideResetButton: {
            type: Boolean,
            reflectToAttribute: true
          },

          /**
           * if true, show timezone inputs
           */
          withTimezone: {
            type: Boolean,
            value: false
          },

          _resetButtonIsInvisible: {
            type: Boolean,
            computed: '_computeResetButtonIsInvisible(_valueIsSet, _defaultValue, valueAsNumber)'
          }
        }
      }

      static get observers() {
        return [
          '_computePartsStep(step)',
          '_computePartsDisabled(_partsStep.*, disabled)'
        ]
      }

      _computeOr(a, b) {
        return Boolean(a || b);
      }

      _computePartOrder(first) {
        return first ? 0 : 1;
      }

      _computeResetButtonIsInvisible(valueIsSet, defaultValue, valueAsNumber) {
        return !valueIsSet || (!isNaN(defaultValue) && defaultValue === valueAsNumber) || this._isSet(valueAsNumber) === false;
      }

      /**
       * compute the steps for the related inputs. The day-input is the highest modified input allthough if the step is higher than a day in seconds it might also change month- or year-inputs.
       */
      _computePartsStep(step) {
        if (step === undefined) return;

        if (step === 0) {
          this.set('_partsStep.day', 0);
          this.set('_partsStep.hour', 0);
          this.set('_partsStep.minute', 0);
          this.set('_partsStep.second', 0);
          this.set('_partsStep.millisecond', 0);
          this.notifyPath('_partsStep');
          this.set('clamp', '');
          return;
        } else if (step < 0.001) {
          this.set('step', 0.001);
          this.set('_partsStep.day', 1);
          this.set('_partsStep.hour', 1);
          this.set('_partsStep.minute', 1);
          this.set('_partsStep.second', 1);
          this.set('_partsStep.millisecond', 1);
          this.notifyPath('_partsStep');
          this.set('clamp', '');
          return;
        }
        step = +step.toFixed(3);

        if (step % 86400 === 0) {
          // step is multiple of a day
          this.set('_partsStep.day', step / 86400);
          this.set('_partsStep.hour', 0);
          this.set('_partsStep.minute', 0);
          this.set('_partsStep.second', 0);
          this.set('_partsStep.millisecond', 0);
          if (this._ifClamped(this.clamp, 'day')) {
            // reset `clamp` to next inferior standing if clamped
            this.set('clamp', 'hour');
          }
        } else if (step % 3600 === 0) {
          // step is multiple of an hour
          this.set('_partsStep.day', 1);
          this.set('_partsStep.hour', step / 3600);
          this.set('_partsStep.minute', 0);
          this.set('_partsStep.second', 0);
          this.set('_partsStep.millisecond', 0);
          if (this._ifClamped(this.clamp, 'hour')) {
            // reset `clamp` to next inferior standing if clamped
            this.set('clamp', 'minute');
          }
        } else if (step % 60 === 0) {
          // step is multiple of a minute
          this.set('_partsStep.day', 1);
          this.set('_partsStep.hour', 1);
          this.set('_partsStep.minute', step / 60);
          this.set('_partsStep.second', 0);
          this.set('_partsStep.millisecond', 0);
          if (this._ifClamped(this.clamp, 'minute')) {
            // reset `clamp` to next inferior standing if clamped
            this.set('clamp', 'second');
          }
        } else if (step % 1 === 0) {
          // step is multiple of a second
          this.set('_partsStep.day', 1);
          this.set('_partsStep.hour', 1);
          this.set('_partsStep.minute', 1);
          this.set('_partsStep.second', step);
          this.set('_partsStep.millisecond', 0);
          if (this._ifClamped(this.clamp, 'second')) {
            // reset `clamp` to next inferior standing if clamped
            this.set('clamp', 'millisecond');
          }
        } else {
          this.set('_partsStep.day', 1);
          this.set('_partsStep.hour', 1);
          this.set('_partsStep.minute', 1);
          this.set('_partsStep.second', 1);
          this.set('_partsStep.millisecond', step * 1000);
          if (this._ifClamped(this.clamp, 'millisecond')) {
            // reset `clamp` to next inferior standing if clamped
            this.set('clamp', '');
          }
        }
        this.notifyPath('_partsStep');
      }

      _computePartsDisabled(change, disabled) {
        if (!(change && change.path)) {
          return;
        }
        if (change.path.indexOf('.') !== -1) {
          const key = '_partsDisabled.' + change.path.split('.')[1];
          if (disabled) {
            this.set(key, true);
          } else {
            this.set(key, !change.value);
          }
        } else if (change && change.value) {
          for (let key in change.value) {
            this.set('_partsDisabled.' + key, disabled || !change.value[key]);
          }
        }

        this.notifyPath('_partsDisabled');
      }
    }
  }
  window.DatetimeInputMixin = DatetimeInputMixin;
</script>
